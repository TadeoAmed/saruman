@startuml Reserve Single Item Decision Flow

start
:Receive item (productID, quantity, price);

:Fetch product with lock;
if (Product found?) then (NO)
    :Return FAILURE\nReason: NOT_FOUND;
    end
else (YES)
    :Continue;
endif

if (Product IsActive?) then (NO)
    :Return FAILURE\nReason: PRODUCT_INACTIVE;
    end
else (YES)
    :Continue;
endif

if (hasStockControl &&\nproduct.HasStock &&\nproduct.Stockeable?) then (YES)
    :Calculate available stock\navailable = stock - reserved;

    if (available == 0?) then (YES)
        :Return FAILURE\nReason: OUT_OF_STOCK;
        end
    else (NO)
        :Continue;
    endif

    if (available < requested\nquantity?) then (YES)
        :Return FAILURE\nReason: INSUFFICIENT_AVAILABLE;
        end
    else (NO)
        :Increment reserved_stock\nin product;
    endif
else (NO - Skip stock validation)
    :Continue\n(no stock control);
endif

:Create OrderItem\n(orderID, productID, qty, price);
:Insert OrderItem into DB;

if (Insert successful?) then (NO)
    :Return ERROR\n(propagate to usecase);
    end
else (YES)
    :Return SUCCESS\nItemSuccess(productID, qty);
    end

@enduml
